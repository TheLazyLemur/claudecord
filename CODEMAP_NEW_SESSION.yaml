title: "/new-session Command Flow"
created: "2026-01-16T00:00:00Z"
summary: "Slash command triggers fresh CLI session creation"
description: |
  Traces how /new-session slash command creates a fresh CLI session:
  handler receives interaction [1a], responds to Discord [1c],
  bot delegates to session manager [2a], manager closes existing [2c],
  factory spawns new CLI process [3a-3d].

sections:
  - id: 1
    title: "Slash Command Reception"
    summary: "Handler receives interaction and responds"
    tree:
      - text: "discordgo fires InteractionCreate event"
        children:
          - block:
              id: "1a"
              title: "OnInteractionCreate handler"
              code: "func (h *Handler) OnInteractionCreate(s DiscordSession, i *discordgo.InteractionCreate) {"
              file: "internal/handler/discord.go"
              line: 113
          - block:
              id: "1b"
              title: "Check command type"
              code: "if i.Type != discordgo.InteractionApplicationCommand {"
              file: "internal/handler/discord.go"
              line: 116
      - text: "Handle new-session command"
        children:
          - block:
              id: "1c"
              title: "Command switch"
              code: "case \"new-session\":"
              file: "internal/handler/discord.go"
              line: 138
          - block:
              id: "1d"
              title: "Respond to interaction"
              code: "if err := s.InteractionRespond(i.Interaction, &discordgo.InteractionResponse{"
              file: "internal/handler/discord.go"
              line: 152
      - text: "Call bot NewSession"
        children:
          - block:
              id: "1e"
              title: "Trigger new session"
              code: "if err := h.bot.NewSession(dir); err != nil {"
              file: "internal/handler/discord.go"
              line: 162

  - id: 2
    title: "Session Management"
    summary: "Bot delegates to SessionManager, closes existing session"
    tree:
      - text: "Bot forwards to session manager"
        children:
          - block:
              id: "2a"
              title: "Bot.NewSession"
              code: "func (b *Bot) NewSession(workDir string) error {"
              file: "internal/core/bot.go"
              line: 55
          - block:
              id: "2b"
              title: "Delegate to manager"
              code: "return b.sessions.NewSession(workDir)"
              file: "internal/core/bot.go"
              line: 56
      - text: "SessionManager creates new session"
        children:
          - block:
              id: "2c"
              title: "SessionManager.NewSession"
              code: "func (m *SessionManager) NewSession(workDir string) error {"
              file: "internal/core/session.go"
              line: 27
          - block:
              id: "2d"
              title: "Acquire lock"
              code: "m.mu.Lock()"
              file: "internal/core/session.go"
              line: 28
      - text: "Close existing session if any"
        children:
          - block:
              id: "2e"
              title: "Close current"
              code: "if m.current != nil {"
              file: "internal/core/session.go"
              line: 31
          - block:
              id: "2f"
              title: "Call Close"
              code: "m.current.Close()"
              file: "internal/core/session.go"
              line: 32
      - text: "Create via factory"
        children:
          - block:
              id: "2g"
              title: "Factory create"
              code: "proc, err := m.factory.Create(\"\", workDir)"
              file: "internal/core/session.go"
              line: 36

  - id: 3
    title: "CLI Process Creation"
    summary: "Factory spawns claude CLI with stdio protocol"
    tree:
      - text: "Factory creates process"
        children:
          - block:
              id: "3a"
              title: "cliProcessFactory.Create"
              code: "func (f *cliProcessFactory) Create(resumeSessionID, workDir string) (core.CLIProcess, error) {"
              file: "cmd/claudecord/main.go"
              line: 25
          - block:
              id: "3b"
              title: "Call NewProcess"
              code: "return cli.NewProcess(workDir, resumeSessionID, initTimeout)"
              file: "cmd/claudecord/main.go"
              line: 31
      - text: "Spawn CLI subprocess"
        children:
          - block:
              id: "3c"
              title: "NewProcess"
              code: "func NewProcess(workingDir, resumeSessionID string, initTimeout time.Duration) (*Process, error) {"
              file: "internal/cli/process.go"
              line: 87
          - block:
              id: "3d"
              title: "Create spawner"
              code: "spawner := NewRealProcessSpawner(workingDir, resumeSessionID)"
              file: "internal/cli/process.go"
              line: 88
      - text: "Configure CLI args"
        children:
          - block:
              id: "3e"
              title: "Build args"
              code: "args := []string{"
              file: "internal/cli/process.go"
              line: 34
          - block:
              id: "3f"
              title: "Create command"
              code: "cmd := exec.Command(\"claude\", args...)"
              file: "internal/cli/process.go"
              line: 45

  - id: 4
    title: "Initialization Handshake"
    summary: "Send init request, wait for CLI acknowledgement"
    tree:
      - text: "Start process and get pipes"
        children:
          - block:
              id: "4a"
              title: "Get stdin pipe"
              code: "stdin, err := spawner.StdinPipe()"
              file: "internal/cli/process.go"
              line: 93
          - block:
              id: "4b"
              title: "Start process"
              code: "if err := spawner.Start(); err != nil {"
              file: "internal/cli/process.go"
              line: 103
      - text: "Run initialize handshake"
        children:
          - block:
              id: "4c"
              title: "Call initialize"
              code: "if err := proc.initialize(initTimeout); err != nil {"
              file: "internal/cli/process.go"
              line: 114
          - block:
              id: "4d"
              title: "Send init request"
              code: "if _, err := p.stdin.Write(append(initMsg, '\\n')); err != nil {"
              file: "internal/cli/process.go"
              line: 146
      - text: "Wait for CLI response"
        children:
          - block:
              id: "4e"
              title: "Scan for response"
              code: "for time.Now().Before(deadline) {"
              file: "internal/cli/process.go"
              line: 156
          - block:
              id: "4f"
              title: "Check control_response"
              code: "if msgType == \"control_response\" {"
              file: "internal/cli/process.go"
              line: 176
