title: "@claude Message Flow"
created: "2026-01-16T00:00:00Z"
summary: "User @claude mention through CLI response to Discord"
description: |
  Traces how a Discord message mentioning @claude flows through the system:
  handler extracts mention [1a], bot orchestrates [2a-2c], CLI processes [3a-3d],
  permissions checked [4a-4b], response posted [5a-5b].

sections:
  - id: 1
    title: "Discord Event Reception"
    summary: "Handler receives message, extracts @claude mention"
    tree:
      - text: "discordgo fires MessageCreate event"
        children:
          - block:
              id: "1a"
              title: "OnMessageCreate handler"
              code: "func (h *Handler) OnMessageCreate(s *discordgo.Session, m *discordgo.MessageCreate) {"
              file: "internal/handler/discord.go"
              line: 93
            children:
              - text: "Skip if author is bot"
                children:
                  - block:
                      id: "1b"
                      title: "Bot author check"
                      code: "if m.Author == nil || m.Author.Bot {"
                      file: "internal/handler/discord.go"
                      line: 96
              - text: "Extract @claude mention from message start"
                children:
                  - block:
                      id: "1c"
                      title: "Extract mention"
                      code: "msg, ok := ExtractClaudeMention(m.Content, m.Mentions, h.botID)"
                      file: "internal/handler/discord.go"
                      line: 100
                  - block:
                      id: "1d"
                      title: "Check mention prefix"
                      code: "if strings.HasPrefix(content, mentionPrefix) {"
                      file: "internal/handler/discord.go"
                      line: 174
              - text: "Forward to bot"
                children:
                  - block:
                      id: "1e"
                      title: "Call bot.HandleMessage"
                      code: "if err := h.bot.HandleMessage(m.ChannelID, msg); err != nil {"
                      file: "internal/handler/discord.go"
                      line: 106

  - id: 2
    title: "Bot Orchestration"
    summary: "Bot acquires session and sends message to CLI"
    tree:
      - text: "Bot receives message, acquires lock"
        children:
          - block:
              id: "2a"
              title: "HandleMessage entry"
              code: "func (b *Bot) HandleMessage(channelID, userMessage string) error {"
              file: "internal/core/bot.go"
              line: 31
          - block:
              id: "2b"
              title: "Acquire mutex"
              code: "b.mu.Lock()"
              file: "internal/core/bot.go"
              line: 32
      - text: "Send typing indicator to Discord"
        children:
          - block:
              id: "2c"
              title: "Send typing"
              code: "b.discord.SendTyping(channelID)"
              file: "internal/core/bot.go"
              line: 36
      - text: "Get or create CLI session"
        children:
          - block:
              id: "2d"
              title: "Get session"
              code: "proc, err := b.sessions.GetOrCreateSession()"
              file: "internal/core/bot.go"
              line: 39
          - block:
              id: "2e"
              title: "SessionManager get/create"
              code: "func (m *SessionManager) GetOrCreateSession() (CLIProcess, error) {"
              file: "internal/core/session.go"
              line: 46
      - text: "Send user message to CLI"
        children:
          - block:
              id: "2f"
              title: "Send to CLI"
              code: "if err := b.sendUserMessage(proc, userMessage); err != nil {"
              file: "internal/core/bot.go"
              line: 46
          - block:
              id: "2g"
              title: "Marshal and send"
              code: "return proc.Send(data)"
              file: "internal/core/bot.go"
              line: 72

  - id: 3
    title: "CLI Process Communication"
    summary: "Process sends/receives JSON via stdio"
    tree:
      - text: "Process writes to CLI stdin"
        children:
          - block:
              id: "3a"
              title: "Process.Send"
              code: "_, err := p.stdin.Write(append(msg, '\\n'))"
              file: "internal/cli/process.go"
              line: 234
      - text: "Bot reads responses from CLI"
        children:
          - block:
              id: "3b"
              title: "processResponses"
              code: "return b.processResponses(proc, channelID)"
              file: "internal/core/bot.go"
              line: 51
          - block:
              id: "3c"
              title: "Get receive channel"
              code: "recvChan, err := proc.Receive()"
              file: "internal/core/bot.go"
              line: 76
          - block:
              id: "3d"
              title: "Read loop"
              code: "go p.readLoop(p.recvChan)"
              file: "internal/cli/process.go"
              line: 241
      - text: "Process response by type"
        children:
          - block:
              id: "3e"
              title: "Type switch"
              code: "switch msgType {"
              file: "internal/core/bot.go"
              line: 103
          - block:
              id: "3f"
              title: "Extract assistant text"
              code: "text := extractTextFromAssistant(msg)"
              file: "internal/core/bot.go"
              line: 105

  - id: 4
    title: "Permission Handling"
    summary: "Tool permission requests checked against allowed dirs"
    tree:
      - text: "CLI sends control_request for tool use"
        children:
          - block:
              id: "4a"
              title: "Handle control request"
              code: "if err := b.handleControlRequest(proc, msg); err != nil {"
              file: "internal/core/bot.go"
              line: 111
          - block:
              id: "4b"
              title: "Check permissions"
              code: "allow, reason := b.perms.Check(toolName, input)"
              file: "internal/core/bot.go"
              line: 171
      - text: "PermissionChecker validates paths"
        children:
          - block:
              id: "4c"
              title: "Check method"
              code: "func (p *PermissionChecker) Check(toolName string, input map[string]any) (allow bool, reason string) {"
              file: "internal/cli/permission.go"
              line: 28
          - block:
              id: "4d"
              title: "Path validation"
              code: "if !p.isAllowed(path) {"
              file: "internal/cli/permission.go"
              line: 35
      - text: "Send permission response to CLI"
        children:
          - block:
              id: "4e"
              title: "Send response"
              code: "return b.sendPermissionResponse(proc, requestID, toolUseID, allow, reason, input)"
              file: "internal/core/bot.go"
              line: 173

  - id: 5
    title: "Response Posting"
    summary: "Post response to Discord, thread if too long"
    tree:
      - text: "Result message signals turn complete"
        children:
          - block:
              id: "5a"
              title: "Result handling"
              code: "case \"result\":"
              file: "internal/core/bot.go"
              line: 115
      - text: "Post accumulated response"
        children:
          - block:
              id: "5b"
              title: "Post response"
              code: "if err := b.postResponse(channelID, responseText); err != nil {"
              file: "internal/core/bot.go"
              line: 119
          - block:
              id: "5c"
              title: "Length check"
              code: "if len(content) > maxDiscordMessageLen {"
              file: "internal/core/bot.go"
              line: 210
      - text: "Thread for long responses"
        children:
          - block:
              id: "5d"
              title: "Create thread"
              code: "_, err := b.discord.CreateThread(channelID, content)"
              file: "internal/core/bot.go"
              line: 211
          - block:
              id: "5e"
              title: "Thread creation"
              code: "thread, err := c.session.MessageThreadStartComplex(channelID, msg.ID, &discordgo.ThreadStart{"
              file: "internal/handler/discord.go"
              line: 49
